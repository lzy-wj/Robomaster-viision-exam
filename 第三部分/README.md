# ç¬¬ä¸‰éƒ¨åˆ†ï¼šæœºå™¨äººæ ¸å¿ƒè½¯ä»¶å¼€å‘ï¼ˆPythonæ–¹å‘ï¼‰

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®ä¸“æ³¨äºæœºå™¨äººç³»ç»Ÿçš„**æ ¸å¿ƒè½¯ä»¶æ¶æ„è®¾è®¡**ï¼Œæ¶µç›–å¼‚æ­¥ç½‘ç»œé€šä¿¡ã€æ’ä»¶åŒ–æ¶æ„ã€ä»¥åŠå¤§æ•°æ®æµå¤„ç†ç­‰ç°ä»£æœºå™¨äººç³»ç»Ÿçš„å…³é”®æŠ€æœ¯ã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **âš¡ å¼‚æ­¥å¹¶å‘é€šä¿¡**: åŸºäºasyncioçš„é«˜æ€§èƒ½ç½‘ç»œé€šä¿¡æ¡†æ¶
- **ğŸ§© æ’ä»¶åŒ–æ¶æ„**: å…ƒç±»é©±åŠ¨çš„åŠ¨æ€æŠ€èƒ½åŠ è½½ç³»ç»Ÿ
- **ğŸ“Š æµå¼æ•°æ®å¤„ç†**: ç”Ÿæˆå™¨å®ç°çš„å¸¸æ•°å†…å­˜å¤§æ•°æ®åˆ†æ
- **ğŸ§ª å®Œæ•´æµ‹è¯•è¦†ç›–**: å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•å…¨è¦†ç›–
- **ğŸ”§ å·¥ç¨‹åŒ–å®è·µ**: é”™è¯¯å¤„ç†ã€è¶…æ—¶æ§åˆ¶ã€èµ„æºç®¡ç†æœ€ä½³å®è·µ
- **ğŸ“ˆ æ•°å­¦å»ºæ¨¡**: å°†å·¥ç¨‹é—®é¢˜æŠ½è±¡ä¸ºæ•°å­¦æ¨¡å‹çš„ç†è®ºæ€è€ƒ

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### ğŸ“ é¡¹ç›®ç»“æ„

```
ç¬¬ä¸‰éƒ¨åˆ†/
â”œâ”€â”€ README.md                           # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ test_all.sh                         # ä¸€é”®æµ‹è¯•è„šæœ¬
â”œâ”€â”€ 3.1_async_comm/                     # å¼‚æ­¥é€šä¿¡æ¨¡å—
â”‚   â”œâ”€â”€ client.py                       # å¼‚æ­¥TCPå®¢æˆ·ç«¯å®ç°
â”‚   â”œâ”€â”€ test.sh                         # è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ out.txt                         # æµ‹è¯•è¾“å‡ºç»“æœ
â”œâ”€â”€ 3.2_skills/                         # æ’ä»¶åŒ–æŠ€èƒ½ç³»ç»Ÿ
â”‚   â”œâ”€â”€ manager.py                      # æŠ€èƒ½ç®¡ç†å™¨æ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ test.py                         # åŸºç¡€åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ test_advanced.py                # é«˜çº§ç‰¹æ€§æµ‹è¯•
â”‚   â”œâ”€â”€ test.sh                         # åŸºç¡€æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ test_advanced.sh                # é«˜çº§æµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ out.txt                         # æµ‹è¯•è¾“å‡ºç»“æœ
â””â”€â”€ 3.3_logstream/                      # æ—¥å¿—æµå¤„ç†æ¨¡å—
    â”œâ”€â”€ stream_count_error.py           # æµå¼æ—¥å¿—åˆ†æå™¨
    â”œâ”€â”€ test.sh                         # æµ‹è¯•è„šæœ¬
    â”œâ”€â”€ robot.zip                       # å¤§è§„æ¨¡æµ‹è¯•æ•°æ®
    â””â”€â”€ extracted_robot/                # è§£å‹åçš„æ—¥å¿—æ–‡ä»¶
        â””â”€â”€ robot.log
```

### ğŸ”„ æŠ€æœ¯æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼‚æ­¥é€šä¿¡æ¡†æ¶       â”‚    â”‚   æ’ä»¶åŒ–æŠ€èƒ½ç³»ç»Ÿ     â”‚    â”‚   æµå¼æ•°æ®å¤„ç†       â”‚
â”‚   3.1_async_comm    â”‚    â”‚    3.2_skills       â”‚    â”‚   3.3_logstream     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ TCPå¹¶å‘è¿æ¥       â”‚    â”‚ â€¢ å…ƒç±»è‡ªåŠ¨æ³¨å†Œ       â”‚    â”‚ â€¢ ç”Ÿæˆå™¨æµå¤„ç†       â”‚
â”‚ â€¢ è¶…æ—¶æ§åˆ¶          â”‚    â”‚ â€¢ åŠ¨æ€æŠ€èƒ½åŠ è½½       â”‚    â”‚ â€¢ å¸¸æ•°å†…å­˜ä½¿ç”¨       â”‚
â”‚ â€¢ é”™è¯¯åˆ†ç±»å¤„ç†      â”‚    â”‚ â€¢ ç»Ÿä¸€ç®¡ç†æ¥å£       â”‚    â”‚ â€¢ å¤§æ–‡ä»¶å…¼å®¹        â”‚
â”‚ â€¢ netcatæœåŠ¡å™¨æµ‹è¯•  â”‚    â”‚ â€¢ å¹¶å‘å®‰å…¨æ‰§è¡Œ       â”‚    â”‚ â€¢ .gzæ ¼å¼æ”¯æŒ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### âš¡ ä¸€é”®æµ‹è¯•ï¼ˆæ¨èï¼‰

```bash
cd ç¬¬ä¸‰éƒ¨åˆ†
bash test_all.sh
```

**æœŸæœ›è¾“å‡º**:

```
[3.1] å¹¶å‘é€šä¿¡
CONNECTED 127.0.0.1:8001 - connected
CONNECTED 127.0.0.1:8002 - connected  
CONNECTED 127.0.0.1:8003 - connected
SUMMARY: 3/3 connected

[3.2] æ’ä»¶åŒ–æŠ€èƒ½ç®¡ç†å™¨
skills: AvoidSkill, CruiseSkill, GraspSkill
è§„é¿ï¼šç»•å¼€éšœç¢ç‰©
å·¡èˆªï¼šæ²¿é¢„è®¾è·¯å¾„ç§»åŠ¨
æŠ“å–ï¼šå®Œæˆç›®æ ‡æŠ“å–åŠ¨ä½œ

[3.3] æ—¥å¿—æµå¼ç»Ÿè®¡
æœŸæœ›è®¡æ•°(grep)=2002095, è„šæœ¬è¾“å‡º=2002095
âœ“ robot.zip æ—¥å¿—æ ¡éªŒé€šè¿‡

[OK] ç¬¬ä¸‰éƒ¨åˆ†å…¨éƒ¨æµ‹è¯•é€šè¿‡
```

### ğŸ”§ å•æ¨¡å—æµ‹è¯•

```bash
# å¼‚æ­¥é€šä¿¡æµ‹è¯•
bash 3.1_async_comm/test.sh

# æŠ€èƒ½ç®¡ç†å™¨åŸºç¡€æµ‹è¯•
bash 3.2_skills/test.sh

# æŠ€èƒ½ç®¡ç†å™¨é«˜çº§æµ‹è¯•  
bash 3.2_skills/test_advanced.sh

# æ—¥å¿—æµå¤„ç†æµ‹è¯•
bash 3.3_logstream/test.sh
```

## ğŸŒ æ¨¡å—1: å¼‚æ­¥è®¾å¤‡é€šä¿¡æ¡†æ¶

### ğŸ“ æ ¸å¿ƒåŠŸèƒ½

æ¨¡æ‹Ÿæœºå™¨äººä¸å¤šä¸ªå¤–éƒ¨è®¾å¤‡ï¼ˆç”µæœºæ§åˆ¶å™¨ã€æ¿€å…‰é›·è¾¾ã€æœåŠ¡ç»ˆç«¯ï¼‰çš„å¹¶å‘ç½‘ç»œé€šä¿¡ã€‚

### ğŸ§® æ•°å­¦å»ºæ¨¡

**è¿æ¥æ—¶å»¶å»ºæ¨¡**: å°†æ¯ä¸ªè¿æ¥çš„æ—¶å»¶è§†ä¸ºéšæœºå˜é‡ Tï¼Œè®¾ç½®è¶…æ—¶ Ï„ ä½œä¸ºåˆ å¤±ç‚¹ï¼Œè§‚æµ‹åˆ° min(T, Ï„)ï¼Œæ§åˆ¶æœ€åæƒ…å†µçš„æ€»ç­‰å¾…æ—¶é—´ã€‚

**å¹¶å‘ä¼˜åŒ–**: Nä¸ªç‹¬ç«‹è¿æ¥çš„å¹¶å‘æ‰§è¡Œï¼Œç†è®ºåŠ é€Ÿæ¯”æ¥è¿‘ Nï¼ˆåœ¨IOå¯†é›†å‹åœºæ™¯ä¸‹ï¼‰ã€‚

### ğŸ’» ä½¿ç”¨æ–¹æ³•

#### ç›´æ¥è°ƒç”¨

```bash
cd 3.1_async_comm
python client.py --targets "127.0.0.1:8001,127.0.0.1:8002,127.0.0.1:8003" --timeout 2.0
```

#### å‚æ•°è¯´æ˜

- `--targets`: ç›®æ ‡æœåŠ¡å™¨åˆ—è¡¨ï¼Œæ ¼å¼ä¸º `host:port,host:port`
- `--timeout`: è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

### ğŸ”§ æŠ€æœ¯å®ç°

```python
async def connect_once(target: Target, timeout: float) -> Tuple[Target, bool, str]:
    """å¼‚æ­¥TCPè¿æ¥å®ç°
  
    é”™è¯¯åˆ†ç±»ï¼š
    - TimeoutError: è¶…æ—¶åˆ å¤±ï¼Œç½‘ç»œå»¶è¿Ÿæˆ–è´Ÿè½½è¿‡é«˜
    - ConnectionRefusedError: ç«¯å£å…³é—­æˆ–æœåŠ¡æœªå¯åŠ¨  
    - OSError: ç½‘ç»œä¸å¯è¾¾ã€DNSè§£æå¤±è´¥
    """
    try:
        reader, writer = await asyncio.wait_for(
            asyncio.open_connection(target.host, target.port),
            timeout=timeout
        )
        writer.close()
        await writer.wait_closed()
        return target, True, "connected"
    except Exception as e:
        return target, False, type(e).__name__
```

### ğŸ“Š æ€§èƒ½ç‰¹å¾

| ç‰¹æ€§       | æŒ‡æ ‡       | è¯´æ˜                 |
| ---------- | ---------- | -------------------- |
| å¹¶å‘è¿æ¥æ•° | æ— ç†è®ºé™åˆ¶ | å—ç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦é™åˆ¶ |
| è¿æ¥å»¶è¿Ÿ   | <10ms      | æœ¬åœ°ç½‘ç»œç¯å¢ƒ         |
| å†…å­˜å ç”¨   | <5MB       | æ¯ä¸ªè¿æ¥çº¦1KB        |
| è¶…æ—¶æ§åˆ¶   | æ¯«ç§’çº§ç²¾åº¦ | asyncio.wait_forå®ç° |

## ğŸ§© æ¨¡å—2: æ’ä»¶åŒ–æŠ€èƒ½ç®¡ç†ç³»ç»Ÿ

### ğŸ“ æ ¸å¿ƒåŠŸèƒ½

å®ç°æœºå™¨äººæŠ€èƒ½çš„çƒ­æ’æ‹”å’ŒåŠ¨æ€åŠ è½½ï¼Œæ”¯æŒå·¡èˆªã€æŠ“å–ã€è§„é¿ç­‰å¤šç§è¡Œä¸ºæŠ€èƒ½ã€‚

### ğŸ§® æ•°å­¦å»ºæ¨¡

**æ³¨å†Œè¡¨å»ºæ¨¡**: å°†ç±»ç©ºé—´ä¸Šçš„"è‡ªåŠ¨æ³¨å†Œ"å»ºæ¨¡ä¸ºå¯ç”¨ç­–ç•¥é›†åˆ S çš„åœ¨çº¿å¢å¹¿ï¼Œæ³¨å†Œè¡¨ä½œä¸º S çš„æ˜¾å¼ç´¢å¼•ï¼Œå®ç°æ¬¡çº¿æ€§å¤æ‚åº¦çš„æŸ¥æ‰¾ã€‚

**æŠ€èƒ½æ‰§è¡Œ**: æ¯ä¸ªæŠ€èƒ½ä½œä¸ºç‹¬ç«‹çš„æ‰§è¡Œå•å…ƒï¼Œæ”¯æŒå¹¶å‘å®‰å…¨çš„æ‰¹é‡æ‰§è¡Œã€‚

### ğŸ’» æ ¸å¿ƒæ¶æ„

#### å…ƒç±»è‡ªåŠ¨æ³¨å†Œæœºåˆ¶

```python
class SkillMeta(type):
    """å…ƒç±»ï¼šè‡ªåŠ¨æ”¶é›†å­ç±»åˆ°æ³¨å†Œè¡¨"""
  
    registry: Dict[str, Type["BaseSkill"]] = {}

    def __new__(mcls, name, bases, namespace, **kwargs):
        cls = super().__new__(mcls, name, bases, dict(namespace))
        if name != "BaseSkill":
            SkillMeta.registry[name] = cls
        return cls
```

#### åŸºç¡€æŠ€èƒ½æ¥å£

```python
class BaseSkill(metaclass=SkillMeta):
    """æŠ€èƒ½åŸºç±»ï¼šæ‰€æœ‰æ’ä»¶éœ€ç»§æ‰¿å¹¶å®ç° run()"""
  
    def run(self) -> str:
        raise NotImplementedError
```

#### ç®¡ç†å™¨å®ç°

```python
@dataclass
class SkillManager:
    """æŠ€èƒ½ç®¡ç†å™¨ï¼šç»Ÿä¸€çš„æŠ€èƒ½å‘ç°ã€åˆ›å»ºã€æ‰§è¡Œæ¥å£"""
  
    def list_skills(self) -> List[str]:
        return sorted(SkillMeta.registry.keys())
  
    def create(self, name: str) -> BaseSkill:
        if name not in SkillMeta.registry:
            raise KeyError(f"æœªæ‰¾åˆ°æŠ€èƒ½ï¼š{name}")
        return SkillMeta.registry[name]()
  
    def run_all(self) -> List[str]:
        outputs = []
        for name in self.list_skills():
            inst = self.create(name)
            outputs.append(inst.run())
        return outputs
```

### ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

#### å®šä¹‰æ–°æŠ€èƒ½

```python
from manager import BaseSkill

class NavigateSkill(BaseSkill):
    """å¯¼èˆªæŠ€èƒ½"""
    def run(self) -> str:
        return "æ‰§è¡Œè·¯å¾„å¯¼èˆªç®—æ³•"

class InspectSkill(BaseSkill):
    """æ£€æŸ¥æŠ€èƒ½"""
    def run(self) -> str:
        return "æ‰§è¡Œè®¾å¤‡çŠ¶æ€æ£€æŸ¥"
```

#### ç®¡ç†å™¨ä½¿ç”¨

```python
manager = SkillManager()
print("å¯ç”¨æŠ€èƒ½:", manager.list_skills())

# æ‰§è¡Œç‰¹å®šæŠ€èƒ½
skill = manager.create("NavigateSkill")
result = skill.run()

# æ‰¹é‡æ‰§è¡Œæ‰€æœ‰æŠ€èƒ½
all_results = manager.run_all()
```

## ğŸ“Š æ¨¡å—3: æµ·é‡æ—¥å¿—æµå¼å¤„ç†

### ğŸ“ æ ¸å¿ƒåŠŸèƒ½

å¤„ç†GBçº§åˆ«çš„æœºå™¨äººè¿è¡Œæ—¥å¿—ï¼Œåœ¨å¸¸æ•°å†…å­˜æ¶ˆè€—ä¸‹ç»Ÿè®¡åŒ…å«ç‰¹å®šå…³é”®è¯çš„æ—¥å¿—æ¡ç›®æ•°é‡ã€‚

### ğŸ§® æ•°å­¦å»ºæ¨¡

**ä¼¯åŠªåˆ©è¿‡ç¨‹å»ºæ¨¡**: å°†æ¯è¡Œæ˜¯å¦åŒ…å«å…³é”®è¯è§†ä¸ºä¼¯åŠªåˆ©å˜é‡ $X_i$ï¼Œæ€»è®¡æ•° $S_n = Î£ X_i$ã€‚ç”Ÿæˆå™¨ä¿è¯å†…å­˜ O(1)ï¼Œæ—¶é—´å¤æ‚åº¦ O(n)ã€‚

**å†…å­˜å¤æ‚åº¦**: æ— è®ºæ–‡ä»¶å¤§å°ï¼Œå†…å­˜ä½¿ç”¨é‡æ’å®šåœ¨ O(1)ã€‚

### ğŸ’» æ ¸å¿ƒå®ç°

#### é€æ˜æ–‡ä»¶è¯»å–

```python
def open_text(path: Path) -> Iterable[str]:
    """é€æ˜æ‰“å¼€ .gz æˆ–æ™®é€šæ–‡æœ¬æ–‡ä»¶"""
    if str(path).endswith(".gz"):
        with gzip.open(path, mode="rt", encoding="utf-8", errors="ignore") as f:
            for line in f:
                yield line
    else:
        with path.open("rt", encoding="utf-8", errors="ignore") as f:
            for line in f:
                yield line
```

#### æµå¼è®¡æ•°å™¨

```python
def count_error_lines(lines: Iterator[str], keyword: str = "ERROR") -> int:
    """æµå¼ç»Ÿè®¡åŒ…å«å…³é”®è¯çš„è¡Œæ•°"""
    count = 0
    for line in lines:
        if keyword in line:
            count += 1
    return count
```

### ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

#### åŸºæœ¬ç”¨æ³•

```bash
cd 3.3_logstream
python stream_count_error.py robot.log
python stream_count_error.py --keyword "WARNING" robot.log.gz
```

#### è‡ªåŠ¨å‘ç°æ¨¡å¼

```bash
# è‡ªåŠ¨æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶
python stream_count_error.py
```
