### CV 与 RoboMaster 视觉理论问答

---

### 一、技术路线对比：传统灯条匹配 vs 基于 CNN 的目标检测

从鲁棒性、实时性、开发成本、可维护性四个维度进行对比：

- **鲁棒性**

  - 传统灯条匹配：
    - 优点：在受控光照、目标形态稳定、干扰有限的场景中鲁棒性高；几何先验（平行、长度比、角度阈值、双灯条配对等）可强约束，误检率低。
    - 局限：对环境变化敏感（曝光、眩光、反射、遮挡、快速形变）；超参数（阈值）与相机参数、灯条功率变化耦合，跨场景迁移成本高。
  - 基于 CNN 的检测：
    - 优点：对复杂背景、光照变化、形变与部分遮挡有更强的适应性；特征学习可泛化到未见过的场景与视角。
    - 局限：对数据依赖强；分布外样本与极端长尾仍可能不稳，需要持续数据闭环。
- **实时性**

  - 传统灯条匹配：
    - 优点：算子轻（阈值化、形态学、轮廓、几何筛选），在嵌入式平台上易达高帧率与低延迟。
    - 局限：为提升鲁棒性引入的多级筛选、RANSAC、精修可能拉长尾时延；在极端干扰下为抑制误检而加的后处理会增时延。
  - 基于 CNN 的检测：
    - 优点：现代轻量模型（MobileNet、YOLO 系列的 nano/small）配合 TensorRT、半精度/量化与流水并发，可达实时；one-stage 架构端到端推理简单。
    - 局限：部署前需要针对硬件进行充分优化（算子融合、batch/IO、内存绑核）；在算力受限平台上，大模型难以稳定达标。
- **开发成本**

  - 传统灯条匹配：
    - 优点：无需数据标注与训练；上手成本低，问题可解释性强，调参路径清晰。
    - 局限：跨赛场/相机/灯条工况切换时需大量人工调参；规则组合复杂后，整体逻辑脆弱且难以穷尽边界条件。
  - 基于 CNN 的检测：
    - 优点：一旦建立数据闭环（采集→标注→训练→验证→部署），新增场景的适配以数据驱动为主，流程标准化。
    - 局限：前期数据体系与训练/评测/部署流水线建设成本高；还需持续的数据维护与算力支持。
- **可维护性**

  - 传统灯条匹配：
    - 优点：模块化强，单点定位问题更容易；出现异常可通过可视化与日志快速定位。
    - 局限：规则堆叠导致耦合度上升；知识更多沉淀在参数与经验中，版本回溯与复现实验困难。
  - 基于 CNN 的检测：
    - 优点：模型-数据-配置三件套可规范化版本管理；通过再训练与蒸馏、量化可平滑演进。
    - 局限：黑箱程度更高；线上问题往往需要回溯数据与训练配置联合分析。

小结：在 RM 视觉任务中，常见工程路线是“经典几何先验 + 轻量 CNN”的混合方案：用 CNN 提升复杂场景下的召回与鲁棒性，用几何先验与时序跟踪抑制误检与稳定姿态估计。

补充（统计学视角）：

- 传统灯条匹配可视为在参数化先验 $\theta$（如长度比、平行性、姿态阈值）下的判别函数 $f_\theta(I)$，对阈值与噪声较敏感；
- 基于 CNN 的检测等价于近似 $\arg\max_y p_\phi(y\mid I)$ 的学习问题，通过经验风险最小化估计 $\phi$。当训练/测试分布接近时，泛化误差受模型容量与正则化共同约束，鲁棒性更好。

---

### 二、为何用卡尔曼滤波而不是简单两帧差分？

简单用两帧位置差近似速度存在根本缺陷：

- **测量噪声与抖动**：像素级测量受传感器噪声、伪影与量化影响，差分会放大噪声；速度估计方差大。
- **非匀速运动与时变采样周期**：目标常伴随加速度、角速度与运动学约束；帧间间隔不恒定时，差分偏差显著。
- **遮挡与丢帧**：缺失观测会使差分不可用，需具备预测与补偿能力。
- **传感-控制闭环需求**：需要不止瞬时速度，更需对下一时刻状态的最优估计与不确定度度量以做决策与融合。

卡尔曼滤波器在机器人运动预测中的核心价值：

- **状态空间建模**：用线性/非线性动力学模型描述状态演化（位置、速度、加速度等），刻画过程噪声与观测噪声。
- **递推最优估计**：交替“预测-更新”，在贝叶斯意义下最小化估计误差协方差，获得带不确定度的状态估计。
- **鲁棒对抗缺测**：在短时观测缺失时依靠模型前向外推，维持可用预测。
- **易于多源融合**：与 IMU、里程计等传感器的融合（扩展/无迹卡尔曼）在统一框架内完成。

因此，卡尔曼滤波解决的是“带噪声与缺测的时序最优估计”问题，而非单纯的数值差分。

补充（模型与方差分析）：

$$
\begin{aligned}
x_k &= A x_{k-1} + B u_{k-1} + w_{k-1},\quad w\sim\mathcal{N}(0,Q),\\
z_k &= H x_k + v_k,\quad v\sim\mathcal{N}(0,R).
\end{aligned}
$$

KF 递推：先验 $\hat x_k^- = A\hat x_{k-1}$、$P_k^- = AP_{k-1}A^\top + Q$，增益 $K_k = P_k^- H^\top (HP_k^- H^\top + R)^{-1}$，更新 $\hat x_k = \hat x_k^- + K_k (z_k - H\hat x_k^-)$。
两帧差分速度 $\hat v_k=(z_k-z_{k-1})/\Delta t$ 的方差在观测独立同分布时近似 $2\sigma_z^2/\Delta t^2$，$\Delta t$ 越小噪声放大越剧烈。

---

### 三、正负样本不均衡与 Focal Loss 的作用

- **什么是正负样本不均衡？**

  - 在 one-stage 检测器中，密集锚框/网格产生海量训练样本，其中绝大多数为背景（负样本），真正覆盖目标的正样本极少，且“易负样本”占据训练批次的大部分。
- **为何会产生负面影响？**

  - 标准交叉熵在大量易负样本上迅速趋近饱和但仍贡献梯度，导致总体梯度被易负样本主导；
  - 模型学习被牵制于区分背景，影响对少量正样本与困难样本（如小目标、遮挡）的学习效率与收敛速度，出现欠拟合与召回下降。
- **Focal Loss 如何缓解？**

  - 通过对易分类样本进行“降权”，聚焦困难样本。其二分类形式为：

    $$
    \mathrm{FL}(p_t) = -\,\alpha\,(1-p_t)^{\gamma}\,\log(p_t)
    $$

    其中 $p_t$ 为对真实类别的预测概率，$\gamma>0$ 为聚焦因子，$\alpha$ 为类别平衡系数。
  - 当样本被正确且自信分类时 $p_t\to 1$，损失被 $(1-p_t)^{\gamma}$ 强烈抑制；而对难样本（小 $p_t$）损失权重更大，从而提升对困难正样本的关注度并改善收敛与最终精度。

补充（梯度重加权视角）：标准交叉熵的有效梯度在“易负样本”上占比过大；Focal Loss 用 $(1-p_t)^{\gamma}$ 重加权，聚焦困难样本，改善优化景观与收敛路径。

---

### 四、为何池化与步长卷积破坏 CNN 的平移同变性？

- **卷积的平移同变性（Equivariance）前提**：当步长为 1 且合理填充时，输入平移会引起输出相同幅度的平移。
- **池化（Pooling）**：
  - 子采样本质上是“取样 + 非线性聚合”，改变了采样相位；
  - 当输入发生 1 像素平移时，池化窗口的对齐关系改变，输出不再是简单平移（尤其是最大池化对边界最敏感）。
- **步长不为 1 的卷积（Strided Conv）**：
  - 与池化类似进行子采样，采样栅格的相位对齐被打破；
  - 轻微的输入位移会导致完全不同的采样点参与卷积，输出模式发生变化。

本质原因是“子采样引入的混叠与相位对齐破坏”。工程上常见缓解手段：模糊池化、将步长设为 1 并用空洞卷积或金字塔特征替代、特征对齐等。

补充（群论与采样视角）：理想卷积对平移群 $\mathcal{T}$ 同变，$\mathcal{C}(T_\delta x)=T_\delta(\mathcal{C}x)$。子采样算子 $S_s$ 不是 $\mathcal{T}$ 的表示，因此 $S_s\circ T_\delta \neq T_\delta\circ S_s$。当步长 $s>1$ 时，1 像素的输入平移会造成采样相位错位并引发混叠。

---

### 五、关于 solvePnP：作用与必备先验

1) **主要作用**：

   - 已知若干 3D 点（物体坐标系）与其在图像上的 2D 投影对应关系，估计相机相对于物体的位姿 $(R, t)$，即旋转与平移（常以罗德里格斯向量与平移向量表示）。

   经典优化目标（重投影误差最小化）：

   $$
   \min_{R,t}\; \sum_i \big\| x_i - \pi\big(K\,[R\mid t] X_i\big) \big\|_2^2,\quad \pi([u,v,w]^\top)=(u/w,\; v/w).
   $$
2) **成功调用所需关键先验**：

   - 物体上对应角点的 3D 坐标（单位与坐标系需一致，如装甲板四角在物体坐标系下的坐标与实际尺寸）；
   - 相机内参矩阵 $K$（焦距与主点）与畸变系数（径向/切向）；
   - 像素坐标系的定义与畸变校正约定（是用原始像面点还是去畸后的点）；
     -（可选但常用）迭代法初值与 RANSAC 参数，用于提升鲁棒性并抑制离群对应点对位姿估计的影响。

---
